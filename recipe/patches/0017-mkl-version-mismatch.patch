From a3ece7552117377895304744892fc4100656fd1e Mon Sep 17 00:00:00 2001
From: CaoE <e.cao@intel.com>
Date: Wed, 28 May 2025 20:04:24 -0700
Subject: [PATCH 1/3] Update

[ghstack-poisoned]
---
 aten/src/ATen/native/mkl/SpectralOps.cpp | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/aten/src/ATen/native/mkl/SpectralOps.cpp b/aten/src/ATen/native/mkl/SpectralOps.cpp
index 8deefaade89c..917bd31f6eb9 100644
--- a/aten/src/ATen/native/mkl/SpectralOps.cpp
+++ b/aten/src/ATen/native/mkl/SpectralOps.cpp
@@ -479,6 +479,16 @@ static Tensor& _exec_fft(Tensor& out, const Tensor& self, IntArrayRef out_sizes,
   const auto value_type = c10::toRealValueType(input.scalar_type());
   out.resize_(batched_out_sizes, MemoryFormat::Contiguous);
 
+  // fix mkl issue
+  // https://github.com/pytorch/pytorch/issues/154477
+  auto istrides = input.strides();
+  for (const auto& stride : istrides) {
+    if (stride == 0) {
+      input = input.clone(MemoryFormat::Contiguous);
+      break;
+    }
+  }
+
   auto descriptor = _plan_mkl_fft(
       input.strides(), out.strides(), signal_size, input.is_complex(),
       out.is_complex(), normalization, forward, value_type);

From fe2e49da9a6b344c4cfa98b22b597ac5f4f81017 Mon Sep 17 00:00:00 2001
From: CaoE <e.cao@intel.com>
Date: Mon, 9 Jun 2025 22:08:12 -0700
Subject: [PATCH 2/3] Update

[ghstack-poisoned]
---
 aten/src/ATen/native/mkl/SpectralOps.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/aten/src/ATen/native/mkl/SpectralOps.cpp b/aten/src/ATen/native/mkl/SpectralOps.cpp
index 6864e2f9b418..979d1e7b1ae0 100644
--- a/aten/src/ATen/native/mkl/SpectralOps.cpp
+++ b/aten/src/ATen/native/mkl/SpectralOps.cpp
@@ -481,8 +481,12 @@ static Tensor& _exec_fft(Tensor& out, const Tensor& self, IntArrayRef out_sizes,
 
   // fix mkl issue
   // https://github.com/pytorch/pytorch/issues/154477
-  if (signal_size[0] > 1 && input.strides()[0] == 0) {
-    input = input.clone(MemoryFormat::Contiguous);
+  auto istrides = input.strides();
+  for (const auto& stride : istrides) {
+    if (stride == 0) {
+      input = input.clone(MemoryFormat::Contiguous);
+      break;
+    }
   }
 
   auto descriptor = _plan_mkl_fft(

From ffa596fd9d1265883c2d76f637b5ea362c9f2922 Mon Sep 17 00:00:00 2001
From: CaoE <e.cao@intel.com>
Date: Tue, 8 Jul 2025 19:30:20 -0700
Subject: [PATCH 3/3] Update

[ghstack-poisoned]
---
 aten/src/ATen/native/mkl/SpectralOps.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/aten/src/ATen/native/mkl/SpectralOps.cpp b/aten/src/ATen/native/mkl/SpectralOps.cpp
index 979d1e7b1ae0..4aa53c5e794b 100644
--- a/aten/src/ATen/native/mkl/SpectralOps.cpp
+++ b/aten/src/ATen/native/mkl/SpectralOps.cpp
@@ -337,6 +337,7 @@ Tensor _fft_c2c_mkl(const Tensor& self, IntArrayRef dim, int64_t normalization,
 #include <cmath>
 
 #include <mkl_dfti.h>
+#include <mkl_version.h>
 #include <ATen/mkl/Exceptions.h>
 #include <ATen/mkl/Descriptors.h>
 #include <ATen/mkl/Limits.h>
@@ -481,13 +482,16 @@ static Tensor& _exec_fft(Tensor& out, const Tensor& self, IntArrayRef out_sizes,
 
   // fix mkl issue
   // https://github.com/pytorch/pytorch/issues/154477
-  auto istrides = input.strides();
-  for (const auto& stride : istrides) {
+#ifdef INTEL_MKL_VERSION
+#if INTEL_MKL_VERSION > 20210400L
+  for (const auto& stride : input.strides()) {
     if (stride == 0) {
       input = input.clone(MemoryFormat::Contiguous);
       break;
     }
   }
+#endif
+#endif
 
   auto descriptor = _plan_mkl_fft(
       input.strides(), out.strides(), signal_size, input.is_complex(),